name: Sync FMCSA Guidance

on:
  schedule:
    # Run every Sunday at 6:00 AM UTC
    - cron: "0 6 * * 0"
  workflow_dispatch:
    inputs:
      mode:
        description: "Sync mode"
        required: false
        default: "incremental"
        type: choice
        options:
          - incremental
          - full
          - dry-run
          - skip-scrape

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Chromium
        run: npx playwright install chromium --with-deps

      - name: Create data directory
        run: mkdir -p data

      - name: Download existing scraped data
        # Cache scraped data between runs for incremental mode
        uses: actions/cache@v4
        with:
          path: data/scraped-guidance.json
          key: scraped-guidance-${{ github.run_number }}
          restore-keys: |
            scraped-guidance-

      - name: Run guidance sync
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          # Headed Playwright needs a virtual display on Linux
          DISPLAY: ":99"
        run: |
          # Start virtual framebuffer for headed browser
          sudo Xvfb :99 -screen 0 1280x720x24 &
          sleep 1

          # Determine flags
          MODE="${{ github.event.inputs.mode || 'incremental' }}"
          FLAGS=""
          case "$MODE" in
            full)        FLAGS="--full" ;;
            dry-run)     FLAGS="--dry-run" ;;
            skip-scrape) FLAGS="--skip-scrape" ;;
            *)           FLAGS="" ;;  # incremental is default
          esac

          npx tsx scripts/sync-guidance.ts $FLAGS

      - name: Upload sync results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-results
          path: |
            data/sync-guidance-result.json
            data/sync-guidance.log
          retention-days: 30

      - name: Post summary
        if: always()
        run: |
          if [ -f data/sync-guidance-result.json ]; then
            echo "## FMCSA Guidance Sync Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            INSERTED=$(jq -r '.imported.inserted' data/sync-guidance-result.json)
            UPDATED=$(jq -r '.imported.updated' data/sync-guidance-result.json)
            NEW_ENTRIES=$(jq -r '.scrapeNewEntries' data/sync-guidance-result.json)
            TOTAL=$(jq -r '.scrapeTotalEntries' data/sync-guidance-result.json)
            DURATION=$(jq -r '.durationMs' data/sync-guidance-result.json)
            ERRORS=$(jq -r '.errors | length' data/sync-guidance-result.json)

            DURATION_S=$((DURATION / 1000))

            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| New entries scraped | $NEW_ENTRIES |" >> $GITHUB_STEP_SUMMARY
            echo "| Total entries | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            echo "| DB inserts | $INSERTED |" >> $GITHUB_STEP_SUMMARY
            echo "| DB updates | $UPDATED |" >> $GITHUB_STEP_SUMMARY
            echo "| Errors | $ERRORS |" >> $GITHUB_STEP_SUMMARY
            echo "| Duration | ${DURATION_S}s |" >> $GITHUB_STEP_SUMMARY

            if [ "$ERRORS" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Errors" >> $GITHUB_STEP_SUMMARY
              jq -r '.errors[]' data/sync-guidance-result.json | while read -r line; do
                echo "- $line" >> $GITHUB_STEP_SUMMARY
              done
            fi
          else
            echo "## Sync failed - no result file" >> $GITHUB_STEP_SUMMARY
          fi
