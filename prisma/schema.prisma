// ─────────────────────────────────────────────────────────────────────────────
// eRegs — Prisma Schema
// ─────────────────────────────────────────────────────────────────────────────

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ── AUTH (Auth.js / NextAuth required tables) ─────────────────────────────────

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ── USERS ─────────────────────────────────────────────────────────────────────

enum UserRole {
  PRO
  FLEET_MANAGER
  ENTERPRISE_ADMIN
  ENTERPRISE_MANAGER
  INTERNAL
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  role          UserRole  @default(PRO)
  password      String?   @db.Text

  // Add-ons
  hazmatAccess Boolean @default(false)

  // Organization membership
  organizationId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Auth.js relations
  accounts Account[]
  sessions Session[]

  // Org relations
  ownedOrganization Organization? @relation("OrgOwner")
  memberOfOrg       Organization? @relation("OrgMembers", fields: [organizationId], references: [id])

  // Billing
  subscription Subscription?

  // Annotations (PRO and above)
  highlights Highlight[]
  notes      Note[]
  bookmarks  Bookmark[]

  // Partner code used at signup (optional)
  partnerCodeId String?
  partnerCode   PartnerCode? @relation(fields: [partnerCodeId], references: [id])
}

// ── ORGANIZATIONS ─────────────────────────────────────────────────────────────

model Organization {
  id   String @id @default(cuid())
  name String

  ownerId String @unique
  owner   User   @relation("OrgOwner", fields: [ownerId], references: [id])

  members User[] @relation("OrgMembers")

  drivers Driver[]
  tablets Tablet[]

  trialEndsAt     DateTime?
  freeInvitesLeft Int       @default(2)

  subscription Subscription?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ── SUBSCRIPTIONS ─────────────────────────────────────────────────────────────

enum SubscriptionPlan {
  PRO
  FLEET_MANAGER
  ENTERPRISE
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  PAUSED
}

model Subscription {
  id String @id @default(cuid())

  userId String? @unique
  orgId  String? @unique

  user User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  org  Organization? @relation(fields: [orgId], references: [id], onDelete: Cascade)

  plan   SubscriptionPlan
  status SubscriptionStatus @default(TRIALING)

  stripeCustomerId     String? @unique
  stripeSubscriptionId String? @unique
  stripePriceId        String?

  hazmatEnabled       Boolean @default(false)
  hazmatStripePriceId String?

  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean   @default(false)

  billingNotes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ── DRIVERS ───────────────────────────────────────────────────────────────────

enum DriverInviteMethod {
  SMS
  EMAIL
}

enum DriverStatus {
  PENDING
  ACTIVE
  ACKNOWLEDGED
  REMOVED
}

model Driver {
  id    String       @id @default(cuid())
  orgId String
  org   Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  name         String
  phone        String?
  email        String?
  inviteMethod DriverInviteMethod

  status DriverStatus @default(PENDING)

  inviteToken          String?   @unique
  inviteTokenExpiresAt DateTime?

  deviceToken String? @unique

  acknowledgedAt         DateTime?
  acknowledgedRegVersion String?

  acknowledgeChargeId String?

  removedAt   DateTime?
  removedById String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  acknowledgements Acknowledgement[]
}

// ── TABLETS ───────────────────────────────────────────────────────────────────

model Tablet {
  id    String       @id @default(cuid())
  orgId String
  org   Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  deviceToken  String   @unique
  unitNumber   String?
  label        String?
  registeredAt DateTime @default(now())
  lastSeenAt   DateTime?
  updatedAt    DateTime @updatedAt

  acknowledgements Acknowledgement[]
}

// ── ACKNOWLEDGEMENTS ──────────────────────────────────────────────────────────

model Acknowledgement {
  id       String @id @default(cuid())
  driverId String
  driver   Driver @relation(fields: [driverId], references: [id])

  regVersion     String
  acknowledgedAt DateTime @default(now())

  deviceToken String
  userAgent   String?
  ipAddress   String?

  tabletId String?
  tablet   Tablet? @relation(fields: [tabletId], references: [id])
}

// ── ANNOTATIONS ───────────────────────────────────────────────────────────────

model Highlight {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  cfr49Part    String
  sectionId    String
  paragraphIds String[]

  color     String   @default("yellow")
  createdAt DateTime @default(now())

  @@index([userId, sectionId])
}

model Note {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  cfr49Part String
  sectionId String

  paragraphIds String[]

  text      String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Bookmark {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  cfr49Part String
  sectionId String

  createdAt DateTime @default(now())

  @@unique([userId, sectionId])
}

// ── PARTNER CODES ─────────────────────────────────────────────────────────────

enum PartnerBillingModel {
  PARTNER_PAYS
  SUBSIDY
  REFERRAL
}

model PartnerCode {
  id   String @id @default(cuid())
  code String @unique
  name String

  billingModel    PartnerBillingModel @default(REFERRAL)
  discountPercent Int                 @default(0)
  active          Boolean             @default(true)
  notes           String?             @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users User[]
}

// ── REGULATION VERSION TRACKING ──────────────────────────────────────────────

model RegSection {
  id      String @id // e.g. "49-390.5"
  title   String
  part    String
  section String

  rawXml         String? @db.Text
  sectionContent Json?

  ecfrVersionDate String
  fetchedAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  changelogs RegChangelog[]
}

model RegChangelog {
  id        String     @id @default(cuid())
  sectionId String
  section   RegSection @relation(fields: [sectionId], references: [id])

  versionDate        String
  changeType         String
  summary            String? @db.Text
  federalRegCitation String?

  effectiveDate DateTime?
  createdAt     DateTime  @default(now())
}

// ── INSIGHTS ─────────────────────────────────────────────────────────────────

enum InsightType {
  FMCSA_GUIDANCE
  VIDEO
  ARTICLE
}

model Insight {
  id   String      @id @default(cuid())
  type InsightType

  title String
  body  String? @db.Text
  url   String?

  durationMinutes Int?
  thumbnailUrl    String?
  publisher       String?

  publishedAt     DateTime?
  readTimeMinutes Int?

  sectionIds   String[]
  paragraphIds String[]

  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdById String?
}

// ── REGULATION CONTENT CACHE (DO NOT MODIFY — populated data) ────────────────

model CachedSection {
  id           String   @id @default(cuid())
  part         String
  section      String   @unique
  title        String
  contentJson  String   @db.Text
  subpartLabel String?
  subpartTitle String?
  ecfrVersion  String
  rawXml       String   @db.Text
  cachedAt     DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([part])
  @@index([ecfrVersion])
}

model CachedPartToc {
  id          String   @id @default(cuid())
  part        String   @unique
  title       String
  tocJson     String   @db.Text
  ecfrVersion String
  cachedAt    DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model CachedImage {
  id          String   @id @default(cuid())
  path        String   @unique
  contentType String
  data        Bytes
  cachedAt    DateTime @default(now())
}
